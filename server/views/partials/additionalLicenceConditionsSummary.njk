{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/button/macro.njk" import govukButton %}

{% macro additionalLicenceConditions(params) %}
    {% set errorMessage = params.validationErrors | findError('additionalLicenceConditions') %}

    {% set conditionCount = params.additionalConditions.length + (1 if params.conditionsWithUploads.length else 0) %}

    {% set title = "Additional licence conditions" + " (" + conditionCount + " selected)" if params.showConditionCountSelectedText else "Additional licence conditions" + " (" + conditionCount + ")" %}
    
    {% set addRemoveBtnText = "Add conditions" if (conditionCount) === 0 else "Add or remove conditions" %}


    {% if params.hideHeading != true %}
        <div class="govuk-grid-row check-answers-header sub-heading-margin-top govuk-!-margin-bottom-6">
            <div class="govuk-grid-column-two-thirds">
                <h2 id="additional-licence-conditions-heading"
                    class="govuk-heading-m">{{ title }}</h2>
            </div>
            {% if params.isEditable %}
                <div class="govuk-grid-column-one-third text-align-right">
                    {{ govukButton({
                        href: "/licence/create/id/" + params.licence.id + "/additional-licence-conditions?fromReview=true",
                        text: addRemoveBtnText,
                        classes: "govuk-button--secondary govuk-!-margin-bottom-0"
                    }) }}
                </div>
            {% endif %}
        </div>
    {% endif %}

    {% set additionalLicenceConditions = [] %}

    {% for condition in params.additionalConditions %}
        {% if condition.uploadSummary.length %}
            {% set actionLink =  "/licence/create/id/" + params.licence.id + "/additional-licence-conditions/condition/" + condition.code + "/file-uploads" %}
        {% elseif condition | checkConditionRequiresInput(params.licence.version) %}
            {% set actionLink =  "/licence/create/id/" + params.licence.id + "/additional-licence-conditions/condition/" + condition.id %}
        {% else %}
            {% set actionLink =  "/licence/create/id/" + params.licence.id + "/additional-licence-conditions" %}
        {% endif %}

        {% set additionalLicenceConditions = (additionalLicenceConditions.push({
            sequence: condition.sequence,
            key: {  text: condition.category },
            value: { html: additionalConditionHtml(condition) },
            actions: {
                items: [
                    {
                        href: actionLink + "?fromReview=true",
                        text: "Change",
                        visuallyHiddenText: "Change condition"
                    }
                ]
            } if params.isEditable
        }), additionalLicenceConditions) %}
    {% endfor %}

    {% if params.conditionsWithUploads.length %}
        {% set conditionsWithUploads = params.conditionsWithUploads | sortConditionsById %}
        {% set conditionHtml = [] %}
        {% for condition in conditionsWithUploads %}
            {% set conditionHtml = (conditionHtml.push(additionalConditionHtml(condition)), conditionHtml) %}
        {% endfor %}
        {% set conditionHtml = conditionHtml | join %}
        {% set additionalLicenceConditions = (additionalLicenceConditions.push({
            sequence: conditionsWithUploads[0].sequence,
            key: {  text: conditionsWithUploads[0].category },
            value: { html: conditionHtml },
            actions: {
                items: [
                    {
                        href: "/licence/create/id/" + params.licence.id + "/additional-licence-conditions/condition/" + conditionsWithUploads[0].code + "/file-uploads?fromReview=true",
                        text: "Change",
                        visuallyHiddenText: "Change condition"
                    }
                ] if params.isEditable
            }
        }), additionalLicenceConditions) %}
    {% endif %}

    {% set additionalLicenceConditions = additionalLicenceConditions | sortConditionsBySequence %}

    {{ govukSummaryList({
        attributes: { id: 'additionalLicenceConditions' },
        classes: 'govuk-!-margin-bottom-9',
        rows: additionalLicenceConditions
    }) }}

{% endmacro %}

{% macro additionalConditionHtml(condition) %}
    <div>
        {{ condition.expandedText }}
    </div>
    {% if condition.data.length %}
        <div class="govuk-!-font-weight-bold govuk-!-margin-top-3">
            {% for entry in condition.data | separatedDataByFieldName %}
                <span class="govuk-!-display-block govuk-!-margin-top-2">{{ entry | formatAddress }}</span>
            {% endfor %}
        </div>
    {% endif %}

    {% if condition.uploadSummary.length %}
        {{ includeExclusionZoneImage(condition) }}
    {% endif %}

{% endmacro %}

{% macro includeExclusionZoneImage(condition) %}
    <div id="exclusion-zone">
        <div class="upload-thumbnail">
            <img src="data:image/jpeg;base64, {{ condition.uploadSummary[0].thumbnailImage }}"
                 alt="Exclusion zone map"/>
        </div>
        <div class="upload-detail govuk-!-padding-bottom-3">
            {{ condition.uploadSummary[0].description }}
        </div>
    </div>
{% endmacro %}
