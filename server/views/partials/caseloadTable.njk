{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "./statusBadge.njk" import statusBadge %}

<table id="caseload" class="govuk-table alternate-shade" data-qa="caseload-detail">
    <thead class="govuk-table__head">
      <th scope="col" class="govuk-table__header">Name</th>
      <th scope="col" id="nomisId" class="govuk-table__header">Nomis ID</th>
      <th scope="col" id="crn" class="govuk-table__header">CRN</th>
      <th scope="col" id="releaseDate" class="govuk-table__header">Release Date</th>
      <th scope="col" id="location" class="govuk-table__header">Location</th>
      <th scope="col" class="govuk-table__header">Licence(s)</th>
      <th scope="col" class="govuk-table__header"></th>
    </thead>

    <tbody class="govuk-table__body govuk-body-s">
    {% for case in caseload.content %}
        <tr class="govuk-table__row">
            <td class="govuk-table__cell">{{ case.surname + ", " + case.forename }}</td>
            <td class="govuk-table__cell">{{ case.nomsId }}</td>
            <td class="govuk-table__cell">{{ case.crn }}</td>
            <td class="govuk-table__cell">{{ case.releaseDate }}</td>
            <td class="govuk-table__cell">{{ case.prisonDescription or "Community" }}</td>
            <td class="govuk-table__cell">
                {%  for licence in case.licences %}
                    <div class="govuk-grid-row govuk-!-margin-bottom-2">
                        <div class="govuk-grid-column-one-quarter">
                          {{ licence.typeCode }}
                        </div>
                        <div class="govuk-grid-column-one-half">
                          {{ statusBadge({ status: licence.statusCode, size: 'small' }, statusConfig) }}
                        </div>
                        <div class="govuk-grid-column-one-quarter">
                          {% if licence.statusCode === 'ACTIVE' or licence.statusCode === 'SUBMITTED' %}
                             <a href="#" class="govuk-link">View</a>
                        {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </td>
            <td class="govuk-table__cell">
                {% set index = case.licences.length -1 %}
                {% if index >= 0 %}
                    {% if case.licences[index].statusCode === 'IN_PROGRESS' or case.licences[index].statusCode === 'REJECTED' %}
                        {{ govukButton({
                            text: "Edit",
                            href: "#",
                            classes: "govuk-button--primary govuk-body-s fixed-width govuk-!-margin-right-2"
                        }) }}
                    {% elseif case.licences[index].statusCode === 'ACTIVE' %}
                        {{ govukButton({
                            text: "Vary",
                            href: "#",
                            classes: "govuk-button--primary govuk-body-s fixed-width govuk-!-margin-right-2"
                        }) }}
                    {% else %}
                        <span class="greyed-text govuk-body-s">Awaiting approval</span>
                        <br/>
                        <br/>
                    {% endif %}
                {% else %}
                    {{ govukButton({
                        text: "Create",
                        href: "#",
                        classes: "govuk-button--primary govuk-body-s fixed-width govuk-!-margin-right-2"
                    }) }}
                {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
