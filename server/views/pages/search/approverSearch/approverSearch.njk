{% extends "layout.njk" %}

{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}
{% from "govuk/components/button/macro.njk" import govukButton %}

{% set pageTitle = applicationName + " - Prison Approver - Search" %}
{% set pageId = "approval-search-page" %}
{% set backLinkHref = backLink %}
{% set noJsBackLink = true %}

{% set approvalNeededResults = [] %}
{% set recentlyApprovedResults = [] %}

{% macro displayResults(tableHeadings, results, tabId, countText, setRecentlyApprovedTab) %}
    <h2 class="govuk-heading-l" id = "{{ tabId }}">{{ countText }}</h2>
    {% if results.length == 0 %}
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
                <p id="approval-search-empty-state-content">No licence approval requests that match "{{ queryTerm }}". Try searching again.</p>
                {% if setRecentlyApprovedTab %}
                    <p>If someoneâ€™s release date was more than 14 days ago, you will no longer be able to see their licence in this service.</p>
                {% endif %}
                <p class="govuk-body">
                    {{ govukButton({
                        text: "Return to caselist",
                        classes: "govuk-button--secondary govuk-!-margin-bottom-0 govuk-body",
                        href: backLink,
                        attributes: { 'data-qa': 'return-to-caselist' }
                    }) }}
                </p>
            </div>
        </div>
    {% else %}
        <form method="GET">
            {{ govukTable({
                attributes: {
                    'data-module': 'moj-sortable-table',
                    'id': 'searchResults'
                },
                caption: caption,
                captionClasses: "govuk-visually-hidden",
                head: tableHeadings,
                rows: results
            }) }}
        </form>
    {% endif %}
{% endmacro %}

{% set searchTableHeadings = [
    {
        text: "Name",
        attributes: {
            "aria-sort": "none"
        }
    },
    {
        text: "Prison number",
        attributes: {
            "aria-sort": "none"
        }
    },
    {
        text: "Probation practitioner",
        attributes: {
            "aria-sort": "none"
        }
    },
    {
        text: "Release date",
        attributes: {
            id: 'release-date-sort',
            "aria-sort": "none"
        }
    }
] %}

{% if selectedMultiplePrisonCaseloads %}
    {% set searchTableHeadings = (searchTableHeadings.splice(3, 0, {
                text: "Location",
                attributes: {
                    "aria-sort": "none"
                }
            }
    ), searchTableHeadings) %}
{% endif %}

{% set approvalNeededSearchTableHeadings = searchTableHeadings.toSpliced(-1, 0, {
                text: "Submitted by",
                attributes: {
                    "aria-sort": "none"
                }
            }
    ) %}

{% set recentlyApprovedSearchTableHeadings = (searchTableHeadings.concat(
    {
        text: "Approved by",
        attributes: {
            "aria-sort": "none"
        }
    },
    {
        text: "Approved on",
        attributes: {
            "aria-sort": "none"
        }
    }
)) %}

{% for case in approvalNeededCases %}
    {% if case.urgentApproval %}
        {% set releaseDate = '<span class="urgent-highlight">' + case.releaseDate
            + '</span><span class="urgent-highlight urgent-highlight-message">Urgent approval required for<br>upcoming release</span>' %}
    {% elseif case.kind == 'HDC' %}
        {% set releaseDate = '<span class="urgent-highlight">' + case.releaseDate
            + '</span><span class="urgent-highlight urgent-highlight-message">HDC release</span>' %}
    {% elseif case.isDueForEarlyRelease %}
        {% set releaseDate = '<span class="urgent-highlight">' + case.releaseDate
            + '</span><span class="urgent-highlight urgent-highlight-message">Early release</span>' %}
    {% else %}
        {% set releaseDate = case.releaseDate %}
    {% endif %}

    {% set result = [
    {
        attributes: {
            id: 'name-' + loop.index,
            "data-sort-value": case.name
        },
        html: '<a href="/licence/approve/id/' + case.licenceId + '/view" class="govuk-link search-highlight" target="_self">' + case.name + '</a>'    },
    {
        attributes: {
            id: 'nomis-id-' + loop.index,
            "data-sort-value": case.prisonerNumber
        },
        html: '<span class="search-highlight">' + case.prisonerNumber  + '</span>'
    },
    {
        attributes: {
            id: 'probation-practitioner-' + loop.index,
            "data-sort-value": case.probationPractitioner
        },
        html: '<a href="/licence/approve/id/' + case.licenceId + '/probation-practitioner" class="govuk-link search-highlight">' + case.probationPractitioner.name + '</a>'
    },
    {
        attributes: {
            id: 'submitted-by-' + loop.index,
            "data-sort-value": case.submittedByFullName
            },
        text: case.submittedByFullName
    },
    {
        attributes: {
            id: 'release-date-' + loop.index,
            "data-sort-value": case.releaseDate | dateToUnix
        },
        html: releaseDate
    }
    ] %}

    {% if selectedMultiplePrisonCaseloads %}
        {% set result = (result.splice(3, 0,
            {
                attributes: {
                    id: 'location-' + loop.index,
                    "data-sort-value": case.prisonDescription
                },
                text: case.prisonDescription
            }
        ), result) %}
    {% endif %}

    {% set approvalNeededResults = (approvalNeededResults.push(result), approvalNeededResults) %}

{% endfor %}

{% for case in recentlyApprovedCases %}
    {% if case.kind == 'HDC' %}
        {% set releaseDate = '<span class="urgent-highlight">' + case.releaseDate
            + '</span><span class="urgent-highlight urgent-highlight-message">HDC release</span>' %}
    {% else %}
        {% set releaseDate = case.releaseDate %}
    {% endif %}

    {% set result = [
        {
            attributes: {
                id: 'name-' + loop.index,
                "data-sort-value": case.name
            },
            html: '<a href="/licence/view/id/' + case.licenceId + '/pdf-print" class="govuk-link search-highlight" target="_blank">' + case.name + '</a>'
        },
    {
        attributes: {
            id: 'nomis-id-' + loop.index,
            "data-sort-value": case.prisonerNumber
        },
        html: '<span class="search-highlight">' + case.prisonerNumber  + '</span>'
    },
    {
        attributes: {
            id: 'probation-practitioner-' + loop.index,
            "data-sort-value": case.probationPractitioner
        },
        html: '<a href="/licence/approve/id/' + case.licenceId + '/probation-practitioner" class="govuk-link search-highlight">' + case.probationPractitioner.name + '</a>'
    },
    {
        attributes: {
            id: 'release-date-' + loop.index,
            "data-sort-value": case.releaseDate | dateToUnix
        },
        html: releaseDate
    },
    {
        attributes: {
            id: 'approved-by-' + loop.index,
            "data-sort-value": case.approvedBy
        },
        text: case.approvedBy
    },
    {
        attributes: {
            id: 'approved-on-' + loop.index,
            "data-sort-value": case.approvedOn | dateToUnix
        },
        text: case.approvedOn
    }
    ] %}

    {% if selectedMultiplePrisonCaseloads %}
        {% set result = (result.splice(3, 0,
            {
                attributes: {
                    id: 'location-' + loop.index,
                    "data-sort-value": case.prisonDescription
                },
                text: case.prisonDescription
            }
        ), result) %}
    {% endif %}

    {% set recentlyApprovedResults = (recentlyApprovedResults.push(result), recentlyApprovedResults) %}

{% endfor %}

{% set approvalNeededCountText = "Approval needed ("  + tabParameters.approvalNeeded.resultsCount + tabParameters.approvalNeeded.resultsCount | pluralise(" result") + ")" %}
{% set recentlyApprovedCountText = "Recently approved (" + tabParameters.recentlyApproved.resultsCount + tabParameters.recentlyApproved.resultsCount | pluralise(" result") + ")" %}

{% set approvalNeeded = displayResults(approvalNeededSearchTableHeadings, approvalNeededResults, tabParameters.approvalNeeded.tabId, approvalNeededCountText, false) %}
{% set recentlyApproved = displayResults(recentlyApprovedSearchTableHeadings, recentlyApprovedResults, tabParameters.recentlyApproved.tabId, recentlyApprovedCountText, true) %}

{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-three-quarters">
            <input type="hidden" id="searchTerm" value="{{ queryTerm }}">
            <input type="hidden" id="activeTab" value="{{ tabParameters.activeTab }}">
            <h1 class="govuk-heading-xl" id="approval-search-heading">Search results for {{ queryTerm }}</h1>
        </div>
    </div>

   <div class="govuk-grid-row">
        <div class="moj-search govuk-grid-column-one-half govuk-!-margin-bottom-8">
            <form method="GET">
                <div class="govuk-form-group">
                    <label class="govuk-label moj-search__label govuk-!-font-weight-bold" for="search">
                        Find a case
                    </label>
                    <div id="search-hint" class="govuk-hint moj-search__hint approver-caseload-search">
                    Search by name, prison number or probation practitioner
                    </div>
                    <input class="govuk-input moj-search__input" id="search" name="queryTerm" aria-describedby="search-hint">
                </div>
                <button class="govuk-button moj-search__button " data-module="govuk-button">
                    Search
                </button>
            </form>
        </div>
    </div>

    {{ govukTabs({
        items: [
            {
                label: approvalNeededCountText,
                id: "approval-needed",
                panel: {
                    html: approvalNeeded
                }
            },
            {
                label: recentlyApprovedCountText,
                id: "recently-approved",
                panel: {
                    html: recentlyApproved
                }
            }
        ]
    }) }}

{% endblock %}

{% block pageScripts %}
    <script src="/assets/js/search/highlightSearchTerm.js"></script>
    <script src="/assets/js/search/setActiveTab.js"></script>
{% endblock %}
