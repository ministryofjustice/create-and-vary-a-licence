{% extends "layout.njk" %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "partials/statusBadge.njk" import statusBadge %}
{% set pageTitle = applicationName + " - view an approved licence" %}
{% set pageId = "view-cases-page" %}
{% set backLinkHref = "/" %}
{% set noJsBackLink = true %}
{% macro offenderName(offenderName, prisonerNumber, licenceId, isClickable, versionOfId, licenceStatus, index) %}
    <div class="caseload-offender-name">
        {% if isClickable %}
            {% set link = "/licence/view/id/" + licenceId + "/show" %}
            {% if versionOfId and licenceStatus === 'SUBMITTED' %}
                {% set link = link + "?lastApprovedVersion=" + versionOfId %}
            {% endif %}
            <a id="name-button-{{ index }}" href={{ link }} class="govuk-link govuk-heading-s">{{ offenderName }}</a>
        {% else %}
            <span id="name-button-{{ index }}" class="govuk-heading-s">{{ offenderName }}</span>
        {% endif %}
    </div>
{% endmacro %}
{% set licences = [] %}
{% for case in cases %}
    {% if case.probationPractitioner %}
        {% set comDetailsHtml = '<a class="govuk-link" href="/licence/view/probation-practitioner/staffCode/' + case.probationPractitioner.staffCode + '">' + case.probationPractitioner.name + '</a>' %}
    {% else %}
        {% set comDetailsHtml = 'Unallocated' %}
    {% endif %}

    {% if case.licenceVersionOf and (case.licenceStatus === 'IN_PROGRESS' or case.licenceStatus === 'SUBMITTED') %}
        {% set licenceStatusHtml = statusBadge({ status: case.licenceStatus, size: 'small' }, statusConfig) +
                                   "<div class='govuk-!-margin-top-2'><svg class='moj-banner__icon' fill='currentColor' role='presentation'" +
                                   "focusable='false' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 25 25' height='25' width='25'>" +
                                   "<path d='M13.7,18.5h-2.4v-2.4h2.4V18.5z M12.5,13.7c-0.7,0-1.2-0.5-1.2-1.2V7.7c0-0.7,0.5-1.2,1.2-1.2s1.2,0.5,1.2,1.2v4.8C13.7,13.2,13.2,13.7,12.5,13.7z M12.5,0.5c-6.6,0-12,5.4-12,12s5.4,12,12,12s12-5.4,12-12S19.1,0.5,12.5,0.5z' /></svg>" +
                                   "<a href='/licence/view/id/" + case.licenceVersionOf + "/show" + "?latestVersion=" + case.licenceId
                                   + "' class='govuk-link'>View last approved licence</a></div>" %}
    {% else %}
        {% set licenceStatusHtml =  statusBadge({ status: case.licenceStatus, size: 'small' }, statusConfig) %}
    {% endif %}

    {% set licences = (licences.push([
        {
            attributes: {
                id: 'name-' + loop.index,
                "data-sort-value": case.name
            },
            html: offenderName(case.name, case.prisonerNumber, case.licenceId, case.isClickable, case.licenceVersionOf, case.licenceStatus, loop.index),
            classes: "max-width max-width-220"
        },
        {
            attributes: {
                id: 'nomis-id-' + loop.index,
                "data-sort-value": case.prisonerNumber
            },
            text: case.prisonerNumber,
            classes: "max-width max-width-120"
        },
        {
            attributes: {
                id: 'com-' + loop.index,
                "data-sort-value": case.probationPractitioner
            },
            html: comDetailsHtml,
            classes: "max-width max-width-200"
        },
        {
            attributes: {
                id: 'release-date-' + loop.index,
                "data-sort-value": case.releaseDate | dateToUnix
            },
            html: '<p>' + case.releaseDateLabel + ': <br>' + case.releaseDate + '</p>' 
        },
        {
            attributes: {
                id: 'licence-status-' + loop.index,
                "data-sort-value": case.licenceStatus | getStatusOrder
            },
            html: licenceStatusHtml
        }
    ]), licences) %}
{% endfor %}

{% if probationView %} {% set probationViewUrlQuery = '?view=probation' %} {% endif %}

{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-three-quarters">
            <h1 class="govuk-heading-xl">Select a person to view or print licences and supervision orders</h1>
        </div>
    </div>
    <div class="moj-search govuk-!-margin-bottom-6">
        <nav class="moj-sub-navigation" aria-label="Sub navigation">
            <ul class="moj-sub-navigation__list">
                <li class="moj-sub-navigation__item">
                    <a class="moj-sub-navigation__link" data-qa="prison-view-link"  {% if not probationView %}aria-current="page"{% endif %} href="?view=prison">People in prison</a>
                </li>
                <li class="moj-sub-navigation__item">
                    <a class="moj-sub-navigation__link"  data-qa="probation-view-link"{% if probationView %}aria-current="page"{% endif %} href="?view=probation">People on probation</a>
                </li> 
                <li class="moj-sub-navigation__item govuk-!-margin-right-0 govuk-!-width-one-half float-right">          
                    <div class="moj-search">
                        <form method="GET">
                            <input type="hidden" name="view" value="{% if probationView %}probation{% else %}prison{% endif %}">
                            <div class="govuk-form-group">
                                <label class="govuk-visually-hidden" for="search">
                                    Search for a case
                                </label>
                                <input class="govuk-input moj-search__input govuk-!-font-size-14" id="search" name="search" placeholder="You can search by name, prison number or probation practitioner" value="{{ search }}">
                            </div>
                            <button class="govuk-button moj-search__button" data-module="govuk-button">
                                Search
                            </button>
                        </form>
                    </div>
                </li>
            </ul>
        </nav>

        {% if hasMultipleCaseloadsInNomis %}
            <div class="govuk-!-padding-top-2 govuk-!-padding-bottom-2 border-bottom">
                <p data-qa="change-caseload">
                    Showing:
                    <span class="govuk-body govuk-!-font-weight-bold" data-qa="caseload-names">
                        {{prisonsToDisplay | extractAttr('description') | join(', ')}} 
                    </span>
                    <a class="govuk-link govuk-!-margin-left-3" href="/licence/view/change-location{{probationViewUrlQuery}}" data-qa="change-location-link">
                        Licences for other establishments
                    </a>
                </p>
            </div>
        {% endif %}

        {% if cases.length > 0 %}
            {{ govukTable({
            attributes: {
                'data-module': 'moj-sortable-table'
            },
            caption: "Print an approved licence",
            captionClasses: "govuk-visually-hidden",
            head: [
                {
                    text: "Name",
                    attributes: {
                        "aria-sort": "none"
                    }
                },
                {
                    text: "Prison number",
                    attributes: {
                        "aria-sort": "none"
                    }
                },
                {
                    text: "Probation practitioner",
                    attributes: {
                        "aria-sort": "none"
                    }
                },
                {
                    text: "Release date",
                    attributes: {
                        "aria-sort":  "descending"  if probationView else  "ascending" 
                    }
                },
                {
                    text: "Status",
                    attributes: {
                        "aria-sort": "none"
                    }
                }
            ],
            rows: licences
        }) }}
        {% else %}
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-three-quarters">
                    <h3 class="govuk-heading-s" data-qa="no-match-message">There are no licences to print which match the search criteria.</h3>
                </div>
            </div>
        {% endif %}
    </div>
    {% endblock %}
