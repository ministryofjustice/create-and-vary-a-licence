{% extends "layout.njk" %}

{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "moj/components/sub-navigation/macro.njk" import mojSubNavigation %}
{% from "partials/statusBadge.njk" import statusBadge %}
{% from "partials/licenceDescription.njk" import licenceDescription %}

{% set pageTitle = applicationName + " - Create a licence - Caseload" %}
{% set pageId = "caseload-page" %}
{% set backLinkHref = "/" %}
{% set noJsBackLink = true %}

{% set offenders = [] %}

{% for offender in caseload %}

    {% if offender.probationPractitioner %}
        {% set comDetailsHtml = '<a class="govuk-link" href="/licence/create/probation-practitioner/staffId/' + offender.probationPractitioner.staffId + '">' + offender.probationPractitioner.name + '</a>' %}
    {% else %}
        {% set comDetailsHtml = 'Unallocated' %}
    {% endif %}

    {% set offenders = (offenders.push([
        {
            attributes: { id: 'name-' + loop.index },
            html: '<button type="submit" name="prisonerNumber" value=' + offender.prisonerNumber +
                  ' class="link-button govuk-heading-s">' + offender.name + '</button>'
        },
        {
            attributes: {
                id: 'crn-' + loop.index
            },
            text: offender.crnNumber
        },
        {
            attributes: {
                id: 'licence-type-' + loop.index
            },
            html: licenceDescription(offender.licenceType)
        },
        {
            attributes: {
                id: 'probation-practitioner-' + loop.index
            },
            html: comDetailsHtml
        },
        {
            attributes: {
                id: 'release-date-' + loop.index
            },
            text: offender.conditionalReleaseDate
        },
        {
            attributes: {
                id: 'licence-status-' + loop.index
            },
            html: statusBadge({ status: offender.licenceStatus, size: 'small' }, statusConfig)
        }
    ]), offenders) %}
{% endfor %}

{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-three-quarters">
            <h1 class="govuk-heading-xl">Select a person to create licences and supervision orders</h1>
        </div>
    </div>

    {{ mojSubNavigation({
        label: 'Sub navigation',
        items: [{
            text: 'My cases',
            href: '?view=me',
            active: not teamView
        }, {
            text: 'Team cases',
            href: '?view=team',
            active: teamView
        }]
    }) }}

    <form method="POST">
        <input type="hidden" name="_csrf" value="{{ csrfToken }}">
        {{ govukTable({
            caption: "Caseload",
            captionClasses: "govuk-visually-hidden",
            head: [
                {
                    text: "Name"
                },
                {
                    text: "CRN"
                },
                {
                    text: "Licence type"
                },
                {
                    text: "Probation Practitioner"
                },
                {
                    text: "Release date"
                },
                {
                    text: "Status"
                }
            ],
            rows: offenders
        }) }}
    </form>
{% endblock %}
