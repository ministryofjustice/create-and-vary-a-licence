{% extends "layout.njk" %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "partials/timePicker.njk" import timePicker %}
{% from "formBuilder.njk" import formBuilder %}

{% set pageTitle = applicationName + " - Create a licence - Additional Conditions" %}
{% set pageId = "additional-condition-input-page" %}
{% set fromReview = "?fromReview=true" if fromReview %}
{% set fromReviewAppend = "&fromReview=true" if fromReview %}

{% set fromPolicyReviewQuery = "?fromPolicyReview=true" if fromPolicyReview %}
{% set fromPolicyReviewAppend = "&fromPolicyReview=true" if fromPolicyReview %}

{% if fromPolicyReview %}
  {% set backLinkHref = "/licence/vary/id/" + licence.id + "/policy-changes/input/callback/"+ (policyReview.policyChangeInputCounter - 1)%}
  {% set noJsBackLink = true%}
{% else %}
  {% set backLinkHref = "/licence/create/id/" + licence.id + "/additional-licence-conditions" %}
{% endif %}
{% set selectedCurfew = formResponses.numberOfCurfews or numberOfCurfews %}
{% set selectedReviewPeriod = formResponses.reviewPeriod or reviewPeriod %}
{% set enteredAlternativeReviewPeriod = formResponses.alternativeReviewPeriod or alternativeReviewPeriod %}

{% block content %}
    {% if fromPolicyReview %}
        <span class="govuk-caption-l">Change {{policyReview.conditionCounter}} of {{policyReview.policyChangesCount}}</span>
    {% endif %}
    <div class="govuk-grid-row govuk-!-margin-bottom-6">
        <div class="govuk-grid-column-three-quarters">
            <h1 class="govuk-heading-l govuk-!-margin-bottom-0">Complete the licence condition</h1>
        </div>
    </div>
    
    <div class="govuk-button-group">
        <form method="POST"
            id="additionConditionInputs"
        >
            <input type="hidden" name="_csrf" value="{{ csrfToken }}">
            <input type="hidden" name="code" value="{{ config.code }}">

            <div class="govuk-grid-row">
                <div class="govuk-grid-column-two-thirds">
                    <p class="govuk-body">
                        {{ config.text }}
                    </p>
                    {% if config.subtext %}
                        <div class="govuk-hint">{{ config.subtext }}</div>
                    {% endif %}

                    {% macro renderTimePicker(id, labelText, formResponses) %}
                        {{ timePicker({
                            name: id,
                            id: id,
                            label: {
                            text: labelText,
                            classes: "govuk-!-font-weight-bold"
                            },
                            hint: {
                            text: "For example, 9:30am or 2:55pm"
                            },
                            errorMessage: validationErrors | findError(id),
                            formResponses: formResponses[id] or curfewTimes[id]
                        }) }}
                    {% endmacro %}

                    {% macro renderCurfews(prefix, count, formResponses) %}
                        {% set ordinals = ['First', 'Second', 'Third', 'Fourth', 'Fifth'] %}
                        {% for i in range(1, count + 1) %}
                            {% set suffix = '' if i === 1 else i %}
                            {% set startId = prefix ~ 'CurfewStart' ~ suffix %}
                            {% set endId = prefix ~ 'CurfewEnd' ~ suffix %}
                            {% set labelPrefix = ordinals[i - 1] %}
                            {{ renderTimePicker(startId, labelPrefix ~ ' curfew – enter the curfew start time', formResponses) }}
                            {{ renderTimePicker(endId, labelPrefix ~ ' curfew – enter the curfew end time', formResponses) }}
                        {% endfor %}
                    {% endmacro %}

                    {% set oneCurfewHtml %}
                        {{ renderCurfews('one', 1, formResponses) }}
                    {% endset %}

                    {% set twoCurfewsHtml %}
                        {{ renderCurfews('two', 2, formResponses) }}
                    {% endset %}

                    {% set threeCurfewsHtml %}
                        {{ renderCurfews('three', 3, formResponses) }}
                    {% endset %}

                    {% set options = [] %}
                    {% set options = [
                        {
                            text: curfewType.ONE_CURFEW,
                            value: curfewType.ONE_CURFEW,
                            checked: selectedCurfew == curfewType.ONE_CURFEW,
                            conditional: {
                                html: oneCurfewHtml
                            }
                        },
                        {
                            text: curfewType.TWO_CURFEWS,
                            value: curfewType.TWO_CURFEWS,
                            checked: selectedCurfew == curfewType.TWO_CURFEWS,
                            conditional: {
                                html: twoCurfewsHtml
                            }
                        },
                        {
                            text: curfewType.THREE_CURFEWS,
                            value: curfewType.THREE_CURFEWS,
                            checked: selectedCurfew == curfewType.THREE_CURFEWS,
                            conditional: {
                                html: threeCurfewsHtml
                            }
                        }
                    ] %}

                    {{
                        govukRadios({
                            idPrefix: "numberOfCurfews",
                            name: "numberOfCurfews",
                            fieldset: {
                                legend: {
                                    text: "Select the number of curfews needed",
                                    classes: "govuk-fieldset__legend govuk-fieldset__legend--m radio-numberOfCurfews-legend"
                                }
                            },
                            items: options,
                            errorMessage: validationErrors | findError('numberOfCurfews')
                        })
                    }}

                    {% set reviewOptions = [
                        {
                            text: "Weekly",
                            value: "Weekly",
                            checked: selectedReviewPeriod == "Weekly"
                        },
                        {
                            text: "Monthly",
                            value: "Monthly",
                            checked: selectedReviewPeriod == "Monthly"
                        },
                        {
                            text: "Other",
                            value: "Other",
                            checked: selectedReviewPeriod == "Other",
                            conditional: {
                            html: govukInput({
                                    id: "alternativeReviewPeriod",
                                    name: "alternativeReviewPeriod",
                                    label: {
                                    text: "Enter a review period",
                                    classes: "govuk-!-font-weight-bold"
                                    },
                                    classes: "govuk-input",
                                    value: enteredAlternativeReviewPeriod,
                                    errorMessage: validationErrors | findError('alternativeReviewPeriod')
                                })
                            }
                        }
                        ] %}

                    {{ govukRadios({
                                    idPrefix: "reviewPeriod",
                                    name: "reviewPeriod",
                                    fieldset: {
                                        legend: {
                                        text: "Select a review period",
                                        classes: "govuk-fieldset__legend govuk-fieldset__legend--m"
                                        }
                                    },
                                    items: reviewOptions,
                                    errorMessage: validationErrors | findError('reviewPeriod')
                                })
                    }}

                    <h2 class="govuk-heading-m govuk-!-margin-bottom-2">Help with this licence condition</h2>

                    {{ govukDetails({
                        summaryText: "If curfews are longer than 12 hours",
                        html: "You must use a bespoke licence condition approved by PPCS if: <ul class='govuk-list--bullet'><li>the total length of someone's curfews is more than 12 hours</li><li>they need more than 3 curfews</li></ul>",
                        classes: "govuk-!-margin-1"
                    }) }}

                    {{ govukDetails({
                        summaryText: "If you are also adding reporting instructions",
                        html: "Add an hour to the total length of someone's curfews each time you ask them to report to a police station or approved premises in an additional licence condition.</br></br>If this total is more than 12 hours, you must use a bespoke condition approved by PPCS.</br></br>For example, if someone had an 11-hour curfew and had to report to a police station twice a day, the total length of their curfews would be 13 hours. This would need PPCS approval.",
                        classes: "govuk-!-margin-1"
                    }) }}

                    <div class="govuk-button-group">
                        {{ govukButton({
                            text: "Continue",
                            type: "submit",
                            classes: 'govuk-!-margin-top-6',
                            attributes: { 'data-qa': 'continue' },
                            preventDoubleClick: true
                        }) }}
                        {{ govukButton({
                            text: "Delete this condition",
                            href: "/licence/create/id/" + licence.id + "/additional-licence-conditions/condition/code/" + additionalConditionCode + "/delete" + fromReview + fromPolicyReviewQuery,
                            classes: 'govuk-button--secondary',
                            attributes: { 'data-qa': 'delete' },
                            preventDoubleClick: true
                        }) }}
                    </div>
                </div>
            </div>
        </form>
    </div>
{% endblock %}

{% block pageScripts %}
    <script src="/assets/js/conditions/addAnother.js"></script>
{% endblock %}

